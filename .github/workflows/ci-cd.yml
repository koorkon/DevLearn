name: CI/CD - Build Test Docker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ---------------------------
    # BACKEND BUILD (MAVEN)
    # ---------------------------
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - name: Backend Build (Maven)
      working-directory: backend
      run: |
        if [ -f pom.xml ]; then
          mvn -B clean verify || mvn -B clean install -DskipTests=true
        else
          echo "No pom.xml — skipping backend build"
        fi

    # ---------------------------
    # FRONTEND BUILD (NODE)
    # ---------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Frontend Build (npm)
      working-directory: frontend
      run: |
        if [ -f package.json ]; then
          npm ci
          npm run build || echo "npm run build failed — check scripts"
        else
          echo "No package.json — skipping frontend build"
        fi

  docker-build:
    runs-on: ubuntu-latest
    needs: build-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Frontend Docker Image
      run: |
        if [ -f frontend/Dockerfile ]; then
          docker build -t frontend-test:latest ./frontend
        else
          echo "No frontend Dockerfile found"
        fi

    - name: Build Backend Docker Image
      run: |
        if [ -f backend/Dockerfile ]; then
          docker build -t backend-test:latest ./backend
        else
          echo "No backend Dockerfile found"
        fi
